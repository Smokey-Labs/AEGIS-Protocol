name: AEGIS GitHub ‚Üí Discord

on:
  issues:
    types: [opened, edited, closed, reopened]
  issue_comment:
    types: [created, edited]
  pull_request:
    types: [opened, edited, closed, reopened, ready_for_review, converted_to_draft, synchronize]
  release:
    types: [published, edited]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Post GitHub event to Discord
        env:
          DISCORD_WEBHOOK_RAW: ${{ secrets.DISCORD_WEBHOOK }}
        shell: bash
        run: |
          set -euo pipefail

          WEBHOOK="$(printf '%s' "${DISCORD_WEBHOOK_RAW:-}" | tr -d '\r\n')"
          if [ -z "$WEBHOOK" ]; then
            echo "Missing DISCORD_WEBHOOK secret"
            exit 1
          fi

          EVENT="${GITHUB_EVENT_NAME}"
          ACTION="$(jq -r '.action // ""' "$GITHUB_EVENT_PATH")"

          sanitize() {
            python3 - "$1" <<'PY'
import sys
s = sys.argv[1] if len(sys.argv) > 1 else ""
s = s.replace("\r", "")
s = s.replace("```", "``\u200b`")
if len(s) > 900:
    s = s[:900] + "‚Ä¶"
print(s)
PY
          }

          post_embed() {
            local title="$1"
            local url="$2"
            local description="$3"
            local field_name="$4"
            local field_value="$5"

            if [ -z "$field_value" ]; then
              field_value="_(no text found)_"
            else
              field_value="```$field_value```"
            fi

            payload="$(
              jq -n \
                --arg title "$title" \
                --arg url "$url" \
                --arg description "$description" \
                --arg field_name "$field_name" \
                --arg field_value "$field_value" \
                '{
                  embeds: [
                    {
                      title: $title,
                      url: $url,
                      description: $description,
                      fields: [
                        {
                          name: $field_name,
                          value: $field_value,
                          inline: false
                        }
                      ]
                    }
                  ]
                }'
            )"

            curl -sS -H "Content-Type: application/json" -X POST -d "$payload" "$WEBHOOK" >/dev/null
          }

          case "$EVENT" in
            issue_comment)
              NUM="$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")"
              TITLE="$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")"
              AUTHOR="$(jq -r '.comment.user.login' "$GITHUB_EVENT_PATH")"
              URL="$(jq -r '.comment.html_url' "$GITHUB_EVENT_PATH")"
              BODY_RAW="$(jq -r '.comment.body // ""' "$GITHUB_EVENT_PATH")"
              BODY="$(sanitize "$BODY_RAW")"

              DESC="[#${NUM}] ${TITLE}\nby **${AUTHOR}**"
              post_embed "üõ°Ô∏è AEGIS ‚Äî Issue Comment ${ACTION}" "$URL" "$DESC" "Comment" "$BODY"
              ;;

            issues)
              NUM="$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")"
              TITLE="$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")"
              AUTHOR="$(jq -r '.sender.login' "$GITHUB_EVENT_PATH")"
              URL="$(jq -r '.issue.html_url' "$GITHUB_EVENT_PATH")"
              STATE="$(jq -r '.issue.state' "$GITHUB_EVENT_PATH")"
              BODY_RAW="$(jq -r '.issue.body // ""' "$GITHUB_EVENT_PATH")"
              BODY="$(sanitize "$BODY_RAW")"

              DESC="[#${NUM}] ${TITLE}\nby **${AUTHOR}** ‚Ä¢ state: **${STATE}**"
              post_embed "üõ°Ô∏è AEGIS ‚Äî Issue ${ACTION}" "$URL" "$DESC" "Body" "$BODY"
              ;;

            pull_request)
              NUM="$(jq -r '.pull_request.number' "$GITHUB_EVENT_PATH")"
              TITLE="$(jq -r '.pull_request.title' "$GITHUB_EVENT_PATH")"
              AUTHOR="$(jq -r '.pull_request.user.login' "$GITHUB_EVENT_PATH")"
              URL="$(jq -r '.pull_request.html_url' "$GITHUB_EVENT_PATH")"
              BRANCH="$(jq -r '.pull_request.head.ref' "$GITHUB_EVENT_PATH")"
              BASE="$(jq -r '.pull_request.base.ref' "$GITHUB_EVENT_PATH")"
              BODY_RAW="$(jq -r '.pull_request.body // ""' "$GITHUB_EVENT_PATH")"
              BODY="$(sanitize "$BODY_RAW")"

              DESC="[#${NUM}] ${TITLE}\nby **${AUTHOR}**\n‚Üí **${BRANCH}** into **${BASE}**"
              post_embed "üõ°Ô∏è AEGIS ‚Äî Pull Request ${ACTION}" "$URL" "$DESC" "Body" "$BODY"
              ;;

            release)
              NAME="$(jq -r '.release.name // .release.tag_name // "Release"' "$GITHUB_EVENT_PATH")"
              TAG="$(jq -r '.release.tag_name // ""' "$GITHUB_EVENT_PATH")"
              AUTHOR="$(jq -r '.release.author.login // .sender.login // "unknown"' "$GITHUB_EVENT_PATH")"
              URL="$(jq -r '.release.html_url' "$GITHUB_EVENT_PATH")"
              NOTES_RAW="$(jq -r '.release.body // ""' "$GITHUB_EVENT_PATH")"
              NOTES="$(sanitize "$NOTES_RAW")"

              if [ -n "$TAG" ]; then
                DESC="**${NAME}** (`${TAG}`)\nby **${AUTHOR}**"
              else
                DESC="**${NAME}**\nby **${AUTHOR}**"
              fi

              post_embed "üöÄ AEGIS ‚Äî Release ${ACTION}" "$URL" "$DESC" "Notes" "$NOTES"
              ;;

            workflow_dispatch)
              URL="https://github.com/${GITHUB_REPOSITORY}/actions"
              DESC="Manual test fired successfully.\nIf you see this, webhook + secret are working."
              post_embed "üß™ AEGIS ‚Äî Manual Test" "$URL" "$DESC" "Status" "OK"
              ;;

            *)
              URL="https://github.com/${GITHUB_REPOSITORY}"
              DESC="Event: **${EVENT}** ${ACTION}"
              post_embed "AEGIS GitHub Update" "$URL" "$DESC" "Info" "See repo for details."
              ;;
          esac
