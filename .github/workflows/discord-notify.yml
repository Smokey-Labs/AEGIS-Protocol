name: AEGIS GitHub ‚Üí Discord

on:
  issues:
    types: [opened, edited, closed, reopened]
  issue_comment:
    types: [created, edited]
  pull_request:
    types: [opened, edited, closed, reopened, ready_for_review, converted_to_draft, synchronize]
  release:
    types: [published, edited]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Post GitHub event to Discord
        env:
          DISCORD_WEBHOOK_RAW: ${{ secrets.DISCORD_WEBHOOK }}
        shell: bash
        run: |
          set -euo pipefail

          WEBHOOK="$(printf '%s' "${DISCORD_WEBHOOK_RAW:-}" | tr -d '\r\n')"
          if [ -z "$WEBHOOK" ]; then
            echo "Missing DISCORD_WEBHOOK secret"
            exit 1
          fi

          EVENT="${GITHUB_EVENT_NAME}"
          ACTION="$(jq -r '.action // ""' "$GITHUB_EVENT_PATH")"

          # helper: clamp text length for Discord
          clamp() {
            # reads stdin, outputs up to 700 chars
            python3 -c 'import sys; s=sys.stdin.read().replace("\r","").strip(); print((s[:700] + ("‚Ä¶" if len(s)>700 else "")) if s else "")'
          }

          # Build message fields per event
          case "$EVENT" in
            issue_comment)
              NUM="$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")"
              TITLE="$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")"
              AUTHOR="$(jq -r '.comment.user.login' "$GITHUB_EVENT_PATH")"
              URL="$(jq -r '.comment.html_url' "$GITHUB_EVENT_PATH")"
              BODY_RAW="$(jq -r '.comment.body // ""' "$GITHUB_EVENT_PATH")"
              BODY="$(printf '%s' "$BODY_RAW" | clamp)"

              MSG=$(
                jq -n --arg num "$NUM" --arg title "$TITLE" --arg author "$AUTHOR" --arg url "$URL" --arg body "$BODY" --arg action "$ACTION" '
                  {
                    content:
                      "üõ°Ô∏è **AEGIS Protocol ‚Äî Issue Comment " + (if $action=="" then "" else ($action | ascii_upcase) end) + "**\n\n" +
                      "[#" + $num + "] " + $title + "\n" +
                      "by **" + $author + "**\n\n" +
                      (if $body=="" then "_(no comment text)_" else ("```" + $body + "```") end) + "\n" +
                      "üîó " + $url
                  }
                '
              )
              ;;

            issues)
              NUM="$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")"
              TITLE="$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")"
              AUTHOR="$(jq -r '.sender.login' "$GITHUB_EVENT_PATH")"
              URL="$(jq -r '.issue.html_url' "$GITHUB_EVENT_PATH")"
              STATE="$(jq -r '.issue.state' "$GITHUB_EVENT_PATH")"

              MSG=$(
                jq -n --arg num "$NUM" --arg title "$TITLE" --arg author "$AUTHOR" --arg url "$URL" --arg state "$STATE" --arg action "$ACTION" '
                  {
                    content:
                      "üõ°Ô∏è **AEGIS Protocol ‚Äî Issue " + (if $action=="" then "" else ($action | ascii_upcase) end) + "**\n\n" +
                      "[#" + $num + "] " + $title + "\n" +
                      "by **" + $author + "**  ‚Ä¢  state: **" + $state + "**\n\n" +
                      "üîó " + $url
                  }
                '
              )
              ;;

            pull_request)
              NUM="$(jq -r '.pull_request.number' "$GITHUB_EVENT_PATH")"
              TITLE="$(jq -r '.pull_request.title' "$GITHUB_EVENT_PATH")"
              AUTHOR="$(jq -r '.pull_request.user.login' "$GITHUB_EVENT_PATH")"
              URL="$(jq -r '.pull_request.html_url' "$GITHUB_EVENT_PATH")"
              BRANCH="$(jq -r '.pull_request.head.ref' "$GITHUB_EVENT_PATH")"
              BASE="$(jq -r '.pull_request.base.ref' "$GITHUB_EVENT_PATH")"

              MSG=$(
                jq -n --arg num "$NUM" --arg title "$TITLE" --arg author "$AUTHOR" --arg url "$URL" --arg branch "$BRANCH" --arg base "$BASE" --arg action "$ACTION" '
                  {
                    content:
                      "üõ°Ô∏è **AEGIS Protocol ‚Äî Pull Request " + (if $action=="" then "" else ($action | ascii_upcase) end) + "**\n\n" +
                      "[#" + $num + "] " + $title + "\n" +
                      "by **" + $author + "**\n" +
                      "‚Üí **" + $branch + "** into **" + $base + "**\n\n" +
                      "üîó " + $url
                  }
                '
              )
              ;;

            release)
              NAME="$(jq -r '.release.name // .release.tag_name // "Release"' "$GITHUB_EVENT_PATH")"
              TAG="$(jq -r '.release.tag_name // ""' "$GITHUB_EVENT_PATH")"
              AUTHOR="$(jq -r '.release.author.login // .sender.login // "unknown"' "$GITHUB_EVENT_PATH")"
              URL="$(jq -r '.release.html_url' "$GITHUB_EVENT_PATH")"
              NOTES_RAW="$(jq -r '.release.body // ""' "$GITHUB_EVENT_PATH")"
              NOTES="$(printf '%s' "$NOTES_RAW" | clamp)"

              MSG=$(
                jq -n --arg name "$NAME" --arg tag "$TAG" --arg author "$AUTHOR" --arg url "$URL" --arg notes "$NOTES" --arg action "$ACTION" '
                  {
                    content:
                      "üöÄ **AEGIS Protocol ‚Äî Release " + (if $action=="" then "" else ($action | ascii_upcase) end) + "**\n\n" +
                      "**" + $name + "**" + (if $tag=="" then "" else ("  (`" + $tag + "`)") end) + "\n" +
                      "by **" + $author + "**\n\n" +
                      (if $notes=="" then "_(no release notes)_" else ("```" + $notes + "```") end) + "\n" +
                      "üîó " + $url
                  }
                '
              )
              ;;

            workflow_dispatch)
              MSG=$(
                jq -n '
                  {
                    content:
                      "üõ°Ô∏è **AEGIS Protocol ‚Äî Manual Test**\n\n" +
                      "workflow_dispatch fired successfully.\n" +
                      "If you can see this, the webhook + secret are working."
                  }
                '
              )
              ;;

            *)
              MSG=$(
                jq -n --arg event "$EVENT" --arg action "$ACTION" '
                  { content: "AEGIS GitHub update: **" + $event + "** " + (if $action=="" then "" else ("(" + $action + ")") end) }
                '
              )
              ;;
          esac

          curl -sS -H "Content-Type: application/json" -X POST -d "$MSG" "$WEBHOOK"
