name: AEGIS GitHub ‚Üí Discord

on:
  issues:
    types: [opened, edited, closed, reopened]
  issue_comment:
    types: [created, edited]
  pull_request:
    types: [opened, edited, closed, reopened, ready_for_review, converted_to_draft, synchronize]
  release:
    types: [published, edited]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send GitHub update to Discord
        env:
          DISCORD_WEBHOOK_RAW: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          set -euo pipefail

          WEBHOOK="$(printf '%s' "$DISCORD_WEBHOOK_RAW" | tr -d '\r\n')"
          [ -z "$WEBHOOK" ] && echo "Missing webhook" && exit 1

          EVENT="${GITHUB_EVENT_NAME}"
          PAYLOAD_FILE="$GITHUB_EVENT_PATH"

          trim() {
            python3 - <<'PY'
          import sys
          txt=sys.stdin.read().strip().replace("\r","")
          print(txt[:700] + ("‚Ä¶" if len(txt) > 700 else ""))
          PY
          }

          case "$EVENT" in
            issue_comment)
              BODY="$(jq -r '.comment.body' "$PAYLOAD_FILE" | trim)"
              MSG="$(jq -r --arg body "$BODY" '
                "üõ°Ô∏è **AEGIS Protocol ‚Äî Issue Comment " + .action + "**\n\n" +
                "[#" + (.issue.number|tostring) + "] " + .issue.title + "\n" +
                "by " + .comment.user.login + "\n\n" +
                "\"" + $body + "\"\n\n" +
                "üîó View comment: " + .comment.html_url
              ' "$PAYLOAD_FILE")"
              ;;
            issues)
              MSG="$(jq -r '
                "üõ°Ô∏è **AEGIS Protocol ‚Äî Issue " + .action + "**\n\n" +
                "[#" + (.issue.number|tostring) + "] " + .issue.title + "\n" +
                "by " + .sender.login + "\n\n" +
                "üîó View issue: " + .issue.html_url
              ' "$PAYLOAD_FILE")"
              ;;
            pull_request)
              MSG="$(jq -r '
                "üõ°Ô∏è **AEGIS Protocol ‚Äî Pull Request " + .action + "**\n\n" +
                "[#" + (.pull_request.number|tostring) + "] " + .pull_request.title + "\n" +
                "by " + .pull_request.user.login + "\n\n" +
                "üîó View PR: " + .pull_request.html_url
              ' "$PAYLOAD_FILE")"
              ;;
            release)
              NOTES="$(jq -r '.release.body' "$PAYLOAD_FILE" | trim)"
              MSG="$(jq -r --arg notes "$NOTES" '
                "üöÄ **AEGIS Protocol ‚Äî New Release**\n\n" +
                .release.name + " (" + .release.tag_name + ")\n\n" +
                $notes + "\n\n" +
                "üîó View release: " + .release.html_url
              ' "$PAYLOAD_FILE")"
              ;;
            *)
              MSG="AEGIS GitHub update: ${EVENT}"
              ;;
          esac

          jq -n --arg content "$MSG" '{content: $content}' \
            | curl -sS -H "Content-Type: application/json" -X POST -d @- "$WEBHOOK"
