name: AEGIS GitHub ‚Üí Discord

on:
  issues:
    types: [opened, edited, closed, reopened]
  issue_comment:
    types: [created, edited]
  pull_request:
    types: [opened, edited, closed, reopened, ready_for_review, converted_to_draft, synchronize]
  release:
    types: [published, edited]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Post GitHub event to Discord
        env:
          DISCORD_WEBHOOK_RAW: ${{ secrets.DISCORD_WEBHOOK }}
        shell: bash
        run: |
          set -euo pipefail

          WEBHOOK="$(printf '%s' "${DISCORD_WEBHOOK_RAW:-}" | tr -d '\r\n')"
          if [ -z "$WEBHOOK" ]; then
            echo "Missing DISCORD_WEBHOOK secret"
            exit 1
          fi

          EVENT="${GITHUB_EVENT_NAME}"
          ACTION="$(jq -r '.action // ""' "$GITHUB_EVENT_PATH")"

          # Sanitize + truncate helper for text that will go inside embed fields
          # - remove CR
          # - prevent ``` from terminating a code block
          # - clamp length
          scrub_and_clamp_jq='
            ( . // "" )
            | gsub("\r"; "")
            | gsub("```"; "``\u200b`")
            | if length > 900 then (.[0:900] + "‚Ä¶") else . end
          '

          case "$EVENT" in
            issue_comment)
              NUM="$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")"
              TITLE="$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")"
              AUTHOR="$(jq -r '.comment.user.login' "$GITHUB_EVENT_PATH")"
              URL="$(jq -r '.comment.html_url' "$GITHUB_EVENT_PATH")"

              # IMPORTANT: comment text is here for issue_comment events
              BODY="$(jq -r ".comment.body | $scrub_and_clamp_jq" "$GITHUB_EVENT_PATH")"

              # If BODY is still empty, print debug to logs (won't post to Discord)
              echo "Event: $EVENT Action: $ACTION"
              echo "Comment body length: ${#BODY}"

              PAYLOAD="$(
                jq -n \
                  --arg title "üõ°Ô∏è AEGIS Protocol ‚Äî Issue Comment ${ACTION}" \
                  --arg issue "#${NUM} ${TITLE}" \
                  --arg author "${AUTHOR}" \
                  --arg url "${URL}" \
                  --arg body "${BODY}" \
                  '{
                    embeds: [
                      {
                        title: $title,
                        url: $url,
                        description: $issue + "\nby **" + $author + "**",
                        fields: [
                          {
                            name: "Comment",
                            value: (if ($body | length) == 0 then "_(no comment text found)_" else ("```" + $body + "```") end),
                            inline: false
                          }
                        ]
                      }
                    ]
                  }'
              )"
              ;;

            issues)
              NUM="$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")"
              TITLE="$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")"
              AUTHOR="$(jq -r '.sender.login' "$GITHUB_EVENT_PATH")"
              URL="$(jq -r '.issue.html_url' "$GITHUB_EVENT_PATH")"
              STATE="$(jq -r '.issue.state' "$GITHUB_EVENT_PATH")"
              BODY="$(jq -r ".issue.body | $scrub_and_clamp_jq" "$GITHUB_EVENT_PATH")"

              PAYLOAD="$(
                jq -n \
                  --arg title "üõ°Ô∏è AEGIS Protocol ‚Äî Issue ${ACTION}" \
                  --arg issue "#${NUM} ${TITLE}" \
                  --arg author "${AUTHOR}" \
                  --arg url "${URL}" \
                  --arg state "${STATE}" \
                  --arg body "${BODY}" \
                  '{
                    embeds: [
                      {
                        title: $title,
                        url: $url,
                        description: $issue + "\nby **" + $author + "** ‚Ä¢ state: **" + $state + "**",
                        fields: [
                          {
                            name: "Body",
                            value: (if ($body | length) == 0 then "_(no issue body)_" else ("```" + $body + "```") end),
                            inline: false
                          }
                        ]
                      }
                    ]
                  }'
              )"
              ;;

            pull_request)
              NUM="$(jq -r '.pull_request.number' "$GITHUB_EVENT_PATH")"
              TITLE="$(jq -r '.pull_request.title' "$GITHUB_EVENT_PATH")"
              AUTHOR="$(jq -r '.pull_request.user.login' "$GITHUB_EVENT_PATH")"
              URL="$(jq -r '.pull_request.html_url' "$GITHUB_EVENT_PATH")"
              BRANCH="$(jq -r '.pull_request.head.ref' "$GITHUB_EVENT_PATH")"
              BASE="$(jq -r '.pull_request.base.ref' "$GITHUB_EVENT_PATH")"
              BODY="$(jq -r ".pull_request.body | $scrub_and_clamp_jq" "$GITHUB_EVENT_PATH")"

              PAYLOAD="$(
                jq -n \
                  --arg title "üõ°Ô∏è AEGIS Protocol ‚Äî Pull Request ${ACTION}" \
                  --arg pr "#${NUM} ${TITLE}" \
                  --arg author "${AUTHOR}" \
                  --arg url "${URL}" \
                  --arg branch "${BRANCH}" \
                  --arg base "${BASE}" \
                  --arg body "${BODY}" \
                  '{
                    embeds: [
                      {
                        title: $title,
                        url: $url,
                        description: $pr + "\nby **" + $author + "**\n‚Üí **" + $branch + "** into **" + $base + "**",
                        fields: [
                          {
                            name: "Body",
                            value: (if ($body | length) == 0 then "_(no PR body)_" else ("```" + $body + "```") end),
                            inline: false
                          }
                        ]
                      }
                    ]
                  }'
              )"
              ;;

            release)
              NAME="$(jq -r '.release.name // .release.tag_name // "Release"' "$GITHUB_EVENT_PATH")"
              TAG="$(jq -r '.release.tag_name // ""' "$GITHUB_EVENT_PATH")"
              AUTHOR="$(jq -r '.release.author.login // .sender.login // "unknown"' "$GITHUB_EVENT_PATH")"
              URL="$(jq -r '.release.html_url' "$GITHUB_EVENT_PATH")"
              NOTES="$(jq -r ".release.body | $scrub_and_clamp_jq" "$GITHUB_EVENT_PATH")"

              PAYLOAD="$(
                jq -n \
                  --arg title "üöÄ AEGIS Protocol ‚Äî Release ${ACTION}" \
                  --arg name "${NAME}" \
                  --arg tag "${TAG}" \
                  --arg author "${AUTHOR}" \
                  --arg url "${URL}" \
                  --arg notes "${NOTES}" \
                  '{
                    embeds: [
                      {
                        title: $title,
                        url: $url,
                        description: "**" + $name + "**" + (if $tag=="" then "" else (" (`" + $tag + "`)") end) + "\nby **" + $author + "**",
                        fields: [
                          {
                            name: "Notes",
                            value: (if ($notes | length) == 0 then "_(no release notes)_" else ("```" + $notes + "```") end),
                            inline: false
                          }
                        ]
                      }
                    ]
                  }'
              )"
              ;;

            workflow_dispatch)
              PAYLOAD="$(
                jq -n '{
                  embeds: [
                    {
                      title: "üõ°Ô∏è AEGIS Protocol ‚Äî Manual Test",
                      description: "workflow_dispatch fired successfully.\nIf you can see this, webhook + secret are working."
                    }
                  ]
                }'
              )"
              ;;

            *)
              PAYLOAD="$(
                jq -n --arg event "$EVENT" --arg action "$ACTION" '{
                  content: ("AEGIS GitHub update: **" + $event + "** " + (if $action=="" then "" else ("(" + $action + ")") end))
                }'
              )"
              ;;
          esac

          curl -sS -H "Content-Type: application/json" -X POST -d "$PAYLOAD" "$WEBHOOK"
