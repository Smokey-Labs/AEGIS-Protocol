jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send event to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          python3 - <<'PY'
          import json, os, urllib.request

          # Load GitHub event payload
          with open(os.environ["GITHUB_EVENT_PATH"], "r", encoding="utf-8") as f:
              payload = json.load(f)

          event = os.environ.get("GITHUB_EVENT_NAME", "")
          actor = os.environ.get("GITHUB_ACTOR", "")
          repo  = os.environ.get("GITHUB_REPOSITORY", "")
          action = payload.get("action", "")

          url = (
              payload.get("issue", {}).get("html_url")
              or payload.get("pull_request", {}).get("html_url")
              or payload.get("release", {}).get("html_url")
              or payload.get("repository", {}).get("html_url")
              or ""
          )
          title = (
              payload.get("issue", {}).get("title")
              or payload.get("pull_request", {}).get("title")
              or payload.get("release", {}).get("name")
              or "(no title)"
          )

          content = f"**{event} â†’ {action}**\n**Repo:** {repo}\n**Title:** {title}\n**By:** {actor}\n{url}"

          body = json.dumps({"content": content}).encode("utf-8")
          req = urllib.request.Request(
              os.environ["DISCORD_WEBHOOK"],
              data=body,
              headers={"Content-Type": "application/json"},
              method="POST",
          )
          with urllib.request.urlopen(req, timeout=20) as resp:
              print("Discord response:", resp.status)
          PY
